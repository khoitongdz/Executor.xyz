<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dead Rails</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <style>
    body {
      margin: 0;
      background: #111;
      font-family: Arial, sans-serif;
    }
    canvas {
      display: block;
      margin: auto;
      border: 2px solid #333;
    }
    #menu {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(0,0,0,0.8);
      z-index: 10;
      flex-direction: column;
      color: white;
    }
    #menu button {
      background: #28a745;
      border: none;
      color: white;
      font-size: 24px;
      padding: 12px 24px;
      margin-top: 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
    }
    #menu button:hover {
      background: #218838;
    }
  </style>
</head>
<body>
<div id="menu">
  <h1>ðŸš† Dead Rails</h1>
  <button onclick="startGame()">Play</button>
</div>

<script>
let playerX, playerY;
let obstacles = [];
let score = 0;
let highscore = 0;
let gameOver = false;
let lanes = [150, 250, 350];
let speed = 5;
let bgY = 0;
let level = 1;
let flash = 0;
let shake = 0;
let skins = ['#e74c3c', '#3498db', '#2ecc71', '#9b59b6'];
let skinColor = '#3498db';
let bgMusic;

function preload() {
  bgMusic = loadSound('https://cdn.pixabay.com/audio/2022/10/20/audio_b7a3e2de4c.mp3');
}

function setup() {
  createCanvas(500, 400);
  textFont('Arial');
  highscore = localStorage.getItem("deadrails_highscore") || 0;
  skinColor = random(skins);
  playerX = lanes[1];
  playerY = 320;
  bgMusic.setVolume(0.2);
  bgMusic.loop();
}

function draw() {
  if (shake > 0) {
    translate(random(-4, 4), random(-4, 4));
    shake--;
  }

  background(20, 20, 40);
  drawRails();

  if (!gameOver) {
    let targetLane = mouseX < width / 3 ? lanes[0] :
                     mouseX < 2 * width / 3 ? lanes[1] : lanes[2];
    playerX = lerp(playerX, targetLane, 0.2);
  }

  drawPlayer();

  // Obstacles
  if (!gameOver && frameCount % 60 === 0) {
    let lane = lanes[int(random(3))];
    obstacles.push({ x: lane, y: -30 });
  }

  for (let i = obstacles.length - 1; i >= 0; i--) {
    obstacles[i].y += speed;
    fill(139, 69, 19);
    rect(obstacles[i].x - 20, obstacles[i].y - 20, 40, 40, 5);
    fill(90);
    rect(obstacles[i].x - 15, obstacles[i].y - 15, 30, 30, 5);

    if (dist(playerX, playerY, obstacles[i].x, obstacles[i].y) < 40) {
      gameOver = true;
      flash = 10;
      shake = 20;
      bgMusic.stop();
      if (score > highscore) {
        highscore = score;
        localStorage.setItem("deadrails_highscore", highscore);
      }
    }

    if (obstacles[i].y > height + 40) {
      obstacles.splice(i, 1);
    }
  }

  // Score
  if (!gameOver) {
    score++;
    level = 1 + int(score / 1000);
    speed = 5 + level * 0.5;
  }

  if (flash > 0) {
    fill(255, 0, 0, 120);
    rect(0, 0, width, height);
    flash--;
  }

  fill(255);
  textSize(18);
  textAlign(LEFT);
  text("Score: " + floor(score / 10), 10, 30);
  text("Level: " + level, 10, 55);
  text("Highscore: " + floor(highscore / 10), 10, 80);

  if (gameOver) {
    fill(0, 0, 0, 180);
    rect(50, 100, 400, 200, 20);
    fill(255);
    textSize(32);
    textAlign(CENTER);
    text("Game Over", width / 2, 160);
    textSize(20);
    text("Score: " + floor(score / 10), width / 2, 200);
    text("Click to try again", width / 2, 240);
    noLoop();
  }
}

function drawPlayer() {
  // Body
  fill(skinColor);
  rect(playerX - 15, playerY - 40, 30, 50, 8);

  // Head
  fill(skinColor);
  ellipse(playerX, playerY - 55, 30);

  // Eyes
  fill(255);
  ellipse(playerX - 6, playerY - 58, 5);
  ellipse(playerX + 6, playerY - 58, 5);

  // Legs
  fill(50);
  rect(playerX - 12, playerY + 10, 8, 15);
  rect(playerX + 4, playerY + 10, 8, 15);
}

function drawRails() {
  for (let y = bgY; y < height; y += 20) {
    stroke(90);
    line(0, y, width, y);
  }
  bgY = (bgY + 2) % 20;

  for (let i = 0; i < 3; i++) {
    stroke(100);
    strokeWeight(4);
    line(lanes[i] - 25, 0, lanes[i] - 25, height);
    line(lanes[i] + 25, 0, lanes[i] + 25, height);

    for (let y = 0; y < height; y += 30) {
      stroke(180);
      strokeWeight(2);
      line(lanes[i] - 25, y, lanes[i] + 25, y);
    }
  }
}

function mousePressed() {
  if (gameOver) {
    resetGame();
  }
}

function resetGame() {
  score = 0;
  speed = 5;
  level = 1;
  playerX = lanes[1];
  skinColor = random(skins);
  obstacles = [];
  gameOver = false;
  loop();
  bgMusic.loop();
}

function startGame() {
  document.getElementById("menu").style.display = "none";
}
</script>
</body>
</html>
